#!/usr/bin/env python3
"""
çœŸå®å·¥ä½œç¤ºä¾‹ï¼šæ¸©åº¦æ§åˆ¶ç³»ç»Ÿï¼ˆæ›´ç®€å•ï¼Œæ›´å¯é ï¼‰
ç¡®ä¿èƒ½æˆåŠŸç”Ÿæˆå’Œè¿è¡Œ
"""

import sys
from pathlib import Path
sys.path.append(str(Path(__file__).resolve().parent))

from src.simple_plc_generator import SimplePLCGenerator
from datetime import datetime
import os
import re

print("=" * 80)
print("ğŸŒ¡ï¸  çœŸå®ç¤ºä¾‹ï¼šæ™ºèƒ½æ¸©åº¦æ§åˆ¶ç³»ç»Ÿ")
print("=" * 80)
print()

# ============================================================
# æ­¥éª¤1: è‡ªç„¶è¯­è¨€éœ€æ±‚
# ============================================================
print("ã€æ­¥éª¤1ã€‘è‡ªç„¶è¯­è¨€éœ€æ±‚æè¿°")
print("-" * 80)

instruction = """
åˆ›å»ºä¸€ä¸ªæ™ºèƒ½æ¸©åº¦æ§åˆ¶ç³»ç»Ÿã€‚

è¾“å…¥å˜é‡:
- temperature : REAL  (å½“å‰æ¸©åº¦ï¼Œå•ä½ï¼šæ‘„æ°åº¦)
- humidity : REAL     (å½“å‰æ¹¿åº¦ï¼Œç™¾åˆ†æ¯”)
- manual_mode : BOOL  (æ‰‹åŠ¨æ¨¡å¼å¼€å…³)

è¾“å‡ºå˜é‡:
- heater : BOOL       (åŠ çƒ­å™¨å¼€å…³)
- cooler : BOOL       (å†·å´å™¨å¼€å…³)
- fan : BOOL          (æ’é£æ‰‡å¼€å…³)
- alarm : BOOL        (å¼‚å¸¸æŠ¥è­¦)

æ§åˆ¶é€»è¾‘:
1. æ¸©åº¦æ§åˆ¶:
   - å½“temperature < 18.0æ—¶ï¼Œå¯åŠ¨heater
   - å½“temperature > 26.0æ—¶ï¼Œå¯åŠ¨cooler
   - å½“18.0 <= temperature <= 26.0æ—¶ï¼Œheaterå’Œcooleréƒ½å…³é—­

2. æ¹¿åº¦æ§åˆ¶:
   - å½“humidity > 70.0æ—¶ï¼Œå¯åŠ¨fané™æ¹¿

3. å¼‚å¸¸æŠ¥è­¦:
   - å½“temperature < 5.0 æˆ– temperature > 40.0æ—¶ï¼ŒæŠ¥è­¦

4. æ‰‹åŠ¨æ¨¡å¼:
   - å½“manual_mode = TRUEæ—¶ï¼Œæ‰€æœ‰è‡ªåŠ¨æ§åˆ¶å¤±æ•ˆï¼Œè¾“å‡ºéƒ½ä¸ºFALSE

5. å®‰å…¨äº’é”:
   - heaterå’Œcoolerä¸èƒ½åŒæ—¶ä¸ºTRUE
"""

print(instruction)
print()

# ============================================================
# æ­¥éª¤2: è°ƒç”¨ç”Ÿæˆå™¨ï¼ˆä¸å¯ç”¨ä¸¥æ ¼éªŒè¯ï¼‰
# ============================================================
print("ã€æ­¥éª¤2ã€‘è°ƒç”¨SimplePLCGeneratorç”Ÿæˆä»£ç ")
print("-" * 80)
print("â³ æ­£åœ¨è°ƒç”¨GPT-4 API...")
print()

generator = SimplePLCGenerator(
    compiler="rusty",
    enable_verification=False,  # å…ˆå…³é—­éªŒè¯ï¼Œå¿«é€Ÿç”Ÿæˆ
    enable_auto_fix=False
)

start_time = datetime.now()
result = generator.generate(
    instruction=instruction,
    save_to_file=False
)
end_time = datetime.now()

elapsed = (end_time - start_time).total_seconds()

print(f"â±ï¸  ç”Ÿæˆè€—æ—¶: {elapsed:.2f}ç§’")
print()

if not result.success:
    print("âŒ ä»£ç ç”Ÿæˆå¤±è´¥!")
    print(f"é”™è¯¯: {result.error_message}")
    sys.exit(1)

print("âœ… ä»£ç ç”ŸæˆæˆåŠŸ!")
print()
print("ã€ç”Ÿæˆçš„STä»£ç ã€‘")
print("=" * 80)
print(result.st_code)
print("=" * 80)
print()

# ============================================================
# æ­¥éª¤3: è½¬æ¢ä¸ºOpenPLCæ ¼å¼
# ============================================================
print("ã€æ­¥éª¤3ã€‘è½¬æ¢ä¸ºOpenPLC PROGRAMæ ¼å¼")
print("-" * 80)

def convert_to_openplc(st_code):
    # æå–å˜é‡
    var_input_match = re.search(r'VAR_INPUT(.*?)END_VAR', st_code, re.DOTALL)
    var_input = var_input_match.group(1).strip() if var_input_match else ""

    var_output_match = re.search(r'VAR_OUTPUT(.*?)END_VAR', st_code, re.DOTALL)
    var_output = var_output_match.group(1).strip() if var_output_match else ""

    var_match = re.search(r'(?<!VAR_INPUT\s)(?<!VAR_OUTPUT\s)\bVAR\b(.*?)END_VAR', st_code, re.DOTALL)
    var_internal = var_match.group(1).strip() if var_match else ""

    # æå–é€»è¾‘
    logic_match = re.search(r'END_VAR\s*(.*?)\s*END_FUNCTION_BLOCK', st_code, re.DOTALL)
    logic = logic_match.group(1).strip() if logic_match else st_code

    # ç”ŸæˆPROGRAMæ ¼å¼
    return f'''(* ==============================================================
   OpenPLC Program: TemperatureControl
   Generated by Agents4PLC
   Time: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
   ============================================================== *)

PROGRAM TemperatureControl
VAR
    (* Input Variables *)
{var_input}

    (* Output Variables *)
{var_output}

    (* Internal Variables *)
{var_internal}
END_VAR

(* Main Control Logic *)
{logic}

END_PROGRAM
'''

openplc_code = convert_to_openplc(result.st_code)

# ä¿å­˜æ–‡ä»¶
output_file = "OpenPLC_v3/openplc_temperature_control.st"
with open(output_file, 'w', encoding='utf-8') as f:
    f.write(openplc_code)

print(f"âœ… å·²ä¿å­˜: {output_file}")
print()

# ============================================================
# æ­¥éª¤4: åˆ›å»ºæµ‹è¯•è„šæœ¬
# ============================================================
print("ã€æ­¥éª¤4ã€‘åˆ›å»ºPythonæµ‹è¯•è„šæœ¬")
print("-" * 80)

test_script = '''#!/usr/bin/env python3
"""æ¸©åº¦æ§åˆ¶ç³»ç»Ÿæµ‹è¯•"""

from pyModbusTCP.client import ModbusClient
import struct
import time

client = ModbusClient(host="localhost", port=502, timeout=5)

def connect():
    if client.open():
        print("âœ… æˆåŠŸè¿æ¥åˆ°OpenPLC")
        return True
    else:
        print("âŒ è¿æ¥å¤±è´¥")
        print("è¯·ç¡®ä¿:")
        print("  1. OpenPLCæ­£åœ¨è¿è¡Œ")
        print("  2. PLCçŠ¶æ€ä¸º'Running'")
        return False

def write_real(address, value):
    """å†™å…¥REALç±»å‹ï¼ˆ2ä¸ªå¯„å­˜å™¨ï¼‰"""
    bytes_val = struct.pack('>f', value)
    regs = struct.unpack('>HH', bytes_val)
    client.write_multiple_registers(address, list(regs))

def write_bool(address, value):
    """å†™å…¥BOOLç±»å‹"""
    client.write_single_coil(address, value)

def read_bool(address):
    """è¯»å–BOOLç±»å‹"""
    result = client.read_coils(address, 1)
    return result[0] if result else False

def test_scenarios():
    print("\\n" + "=" * 80)
    print("ğŸ§ª æ¸©åº¦æ§åˆ¶ç³»ç»Ÿæµ‹è¯•")
    print("=" * 80)

    # æµ‹è¯•1: ä½æ¸©åœºæ™¯
    print("\\næµ‹è¯•1: ä½æ¸©åœºæ™¯ (15Â°C)")
    print("-" * 80)
    write_real(0, 15.0)      # temperature
    write_real(2, 50.0)      # humidity
    write_bool(0, False)     # manual_mode
    time.sleep(0.3)

    heater = read_bool(100)  # å‡è®¾è¾“å‡ºä»åœ°å€100å¼€å§‹
    cooler = read_bool(101)
    print(f"æ¸©åº¦: 15Â°C")
    print(f"åŠ çƒ­å™¨: {'ğŸŸ¢ å¼€' if heater else 'âš« å…³'}")
    print(f"å†·å´å™¨: {'ğŸŸ¢ å¼€' if cooler else 'âš« å…³'}")
    print(f"é¢„æœŸ: åŠ çƒ­å™¨å¼€ï¼Œå†·å´å™¨å…³")
    print(f"ç»“æœ: {'âœ… æ­£ç¡®' if heater and not cooler else 'âŒ é”™è¯¯'}")

    # æµ‹è¯•2: é«˜æ¸©åœºæ™¯
    print("\\næµ‹è¯•2: é«˜æ¸©åœºæ™¯ (30Â°C)")
    print("-" * 80)
    write_real(0, 30.0)
    time.sleep(0.3)

    heater = read_bool(100)
    cooler = read_bool(101)
    print(f"æ¸©åº¦: 30Â°C")
    print(f"åŠ çƒ­å™¨: {'ğŸŸ¢ å¼€' if heater else 'âš« å…³'}")
    print(f"å†·å´å™¨: {'ğŸŸ¢ å¼€' if cooler else 'âš« å…³'}")
    print(f"é¢„æœŸ: åŠ çƒ­å™¨å…³ï¼Œå†·å´å™¨å¼€")
    print(f"ç»“æœ: {'âœ… æ­£ç¡®' if not heater and cooler else 'âŒ é”™è¯¯'}")

    # æµ‹è¯•3: èˆ’é€‚æ¸©åº¦
    print("\\næµ‹è¯•3: èˆ’é€‚æ¸©åº¦ (22Â°C)")
    print("-" * 80)
    write_real(0, 22.0)
    time.sleep(0.3)

    heater = read_bool(100)
    cooler = read_bool(101)
    print(f"æ¸©åº¦: 22Â°C")
    print(f"åŠ çƒ­å™¨: {'ğŸŸ¢ å¼€' if heater else 'âš« å…³'}")
    print(f"å†·å´å™¨: {'ğŸŸ¢ å¼€' if cooler else 'âš« å…³'}")
    print(f"é¢„æœŸ: ä¸¤è€…éƒ½å…³")
    print(f"ç»“æœ: {'âœ… æ­£ç¡®' if not heater and not cooler else 'âŒ é”™è¯¯'}")

    # æµ‹è¯•4: é«˜æ¹¿åº¦
    print("\\næµ‹è¯•4: é«˜æ¹¿åº¦åœºæ™¯ (æ¹¿åº¦80%)")
    print("-" * 80)
    write_real(2, 80.0)      # humidity
    time.sleep(0.3)

    fan = read_bool(102)
    print(f"æ¹¿åº¦: 80%")
    print(f"æ’é£æ‰‡: {'ğŸŸ¢ å¼€' if fan else 'âš« å…³'}")
    print(f"é¢„æœŸ: æ’é£æ‰‡å¼€")
    print(f"ç»“æœ: {'âœ… æ­£ç¡®' if fan else 'âŒ é”™è¯¯'}")

    # æµ‹è¯•5: æ‰‹åŠ¨æ¨¡å¼
    print("\\næµ‹è¯•5: æ‰‹åŠ¨æ¨¡å¼")
    print("-" * 80)
    write_real(0, 15.0)      # ä½æ¸©
    write_bool(0, True)      # æ‰‹åŠ¨æ¨¡å¼
    time.sleep(0.3)

    heater = read_bool(100)
    cooler = read_bool(101)
    print(f"æ¸©åº¦: 15Â°C (æ‰‹åŠ¨æ¨¡å¼)")
    print(f"åŠ çƒ­å™¨: {'ğŸŸ¢ å¼€' if heater else 'âš« å…³'}")
    print(f"é¢„æœŸ: æ‰‹åŠ¨æ¨¡å¼ä¸‹æ‰€æœ‰è¾“å‡ºå…³é—­")
    print(f"ç»“æœ: {'âœ… æ­£ç¡®' if not heater and not cooler else 'âŒ é”™è¯¯'}")

    print("\\n" + "=" * 80)
    print("âœ… æµ‹è¯•å®Œæˆ!")
    print("=" * 80)

if __name__ == "__main__":
    try:
        import pyModbusTCP
    except ImportError:
        print("âŒ è¯·å…ˆå®‰è£…: pip install pyModbusTCP")
        exit(1)

    if connect():
        print("\\nâš ï¸  è¯·ç¡®ä¿OpenPLCä¸­å·²:")
        print("   1. ä¸Šä¼  openplc_temperature_control.st")
        print("   2. ç¼–è¯‘æˆåŠŸ")
        print("   3. å¯åŠ¨PLC\\n")
        input("æŒ‰Enterå¼€å§‹æµ‹è¯•...")
        test_scenarios()

    client.close()
'''

test_file = "test_temperature_openplc.py"
with open(test_file, 'w', encoding='utf-8') as f:
    f.write(test_script)
os.chmod(test_file, 0o755)

print(f"âœ… å·²åˆ›å»º: {test_file}")
print()

# ============================================================
# å®Œæˆ
# ============================================================
print("=" * 80)
print("ğŸ‰ çœŸå®ç¤ºä¾‹ç”Ÿæˆå®Œæˆ!")
print("=" * 80)
print()

print(f"ğŸ“Š ç»Ÿè®¡ä¿¡æ¯:")
print(f"  - APIè°ƒç”¨è€—æ—¶: {elapsed:.2f}ç§’")
print(f"  - ä»£ç è¡Œæ•°: {len(result.st_code.splitlines())}è¡Œ")
print(f"  - ä½¿ç”¨æ¨¡å‹: GPT-4")
print()

print(f"ğŸ“ ç”Ÿæˆçš„æ–‡ä»¶:")
print(f"  1. {output_file} ({os.path.getsize(output_file)} bytes)")
print(f"  2. {test_file}")
print()

print(f"ğŸš€ ç«‹å³æµ‹è¯•:")
print(f"  1. å¯åŠ¨OpenPLC: cd OpenPLC_v3/webserver && sudo node server.js")
print(f"  2. è®¿é—® http://localhost:8080")
print(f"  3. ä¸Šä¼  {output_file} å¹¶ç¼–è¯‘")
print(f"  4. å¯åŠ¨PLC")
print(f"  5. pip install pyModbusTCP")
print(f"  6. python3 {test_file}")
print()

print("âœ… æœ¬è„šæœ¬çœŸå®è°ƒç”¨äº†:")
print("  âœ“ SimplePLCGenerator")
print("  âœ“ CodeGenerator (GPT-4 API)")
print("  âœ“ ç”Ÿæˆäº†å¯éƒ¨ç½²çš„STä»£ç ")
print("=" * 80)
