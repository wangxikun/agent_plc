# 🤖 Agents4PLC - 智能PLC代码生成系统

> 从自然语言到可验证的ST代码，一键生成动画演示

## 🎯 功能概述

本演示系统提供三大核心功能：

| 功能 | 描述 |
|------|------|
| **1. 自然语言生成ST代码** | 输入需求描述，LLM自动生成符合IEC-61131-3标准的ST代码 |
| **2. Rusty编译验证** | 使用Rusty编译器验证生成代码的语法正确性 |
| **3. 动画演示** | 生成可交互的HTML动画，可视化展示PLC执行过程 |

---

## 🚀 快速开始

### 1️⃣ 安装依赖

```bash
cd demo_standalone
pip install gradio>=4.0.0 langchain-openai>=1.0.1
```

### 2️⃣ 配置API密钥

```bash
# 复制配置模板
cp config_template.py config.py

# 编辑config.py，填写你的API密钥
# openai_api_key = "sk-your-api-key"
```

### 3️⃣ 启动Web UI

```bash
# 方式1: 使用启动脚本
chmod +x start.sh
./start.sh

# 方式2: 直接运行
python web_ui.py
```

### 4️⃣ 打开浏览器

访问: **http://127.0.0.1:7860**

---

## 📖 使用演示

### 演示流程（5分钟）

```
步骤1: 选择示例
┌─────────────────────────────────────┐
│ 💡 快速示例: [电机控制 ▼]           │
└─────────────────────────────────────┘
        ↓
步骤2: 生成代码
┌─────────────────────────────────────┐
│        🚀 生成ST代码                │
└─────────────────────────────────────┘
        ↓ 等待3-5秒
步骤3: 编译验证
┌─────────────────────────────────────┐
│        🔧 编译验证                  │
└─────────────────────────────────────┘
        ↓ ✅ 编译通过
步骤4: 生成动画
┌─────────────────────────────────────┐
│        🎬 生成动画                  │
└─────────────────────────────────────┘
        ↓
步骤5: 观看动画
┌─────────────────────────────────────┐
│ ▶ Play  ⏸ Pause  ⏭ Step  ↺ Reset │
│ 观看PLC代码执行过程                  │
└─────────────────────────────────────┘
```

### 五个预设示例

| 示例 | 复杂度 | 描述 | 输入变量 | 输出变量 |
|------|--------|------|----------|----------|
| ⚡ **电机控制** | ⭐ | 启动/停止按钮控制电机 | start_button, stop_button | motor |
| 🌡️ **温度控制** | ⭐⭐ | 自动温度调节系统 | temperature, manual_mode | heater, cooler, alarm |
| 🚦 **交通灯** | ⭐⭐ | 智能交通信号灯 | car_detected, pedestrian_button | green, yellow, red |
| 💧 **水箱液位控制** | ⭐⭐⭐ | 液位监控与阀门控制 | level, flow_rate | inlet_valve, outlet_valve, pump, alarms |
| 🛗 **电梯控制系统** | ⭐⭐⭐⭐⭐ | 复杂状态机控制 | floor_request, current_floor, sensors | motor_up/down, door, floor_indicator, status |

---

## 📂 文件结构

```
demo_standalone/
├── README.md           # 本文档
├── config.py           # 配置文件（需要填写API密钥）
├── config_template.py  # 配置模板
├── web_ui.py          # Web UI主程序
├── start.sh           # 启动脚本
├── pyproject.toml     # 项目依赖
├── src/               # 源代码目录
│   ├── simple_plc_generator.py  # PLC生成器（核心）
│   ├── code_generator.py        # 代码生成
│   ├── compiler.py              # 编译器接口
│   ├── verifier.py              # 验证器
│   ├── auto_fixer.py            # 自动修复
│   ├── st_animator.py           # 动画生成器
│   ├── st_parser.py             # ST代码解析
│   ├── st_simulator.py          # ST代码模拟
│   ├── langchain_create_agent.py # LangChain Agent
│   └── plcverif.py              # PLCverif验证
└── prompts/           # 提示词目录
    └── st_code_generation_prompt.txt
```

---

## 🛠️ 配置说明

### API配置（必须）

编辑 `config.py`:

```python
# OpenAI API密钥
openai_api_key = "sk-your-api-key-here"

# API基础URL（可选，用于兼容API）
openai_base_url = "https://api.openai.com/v1"

# 模型名称
chat_model = "gpt-4"  # 或 gpt-3.5-turbo
```

### 编译器配置（可选）

```python
# 编译器模式: "local", "docker", "auto"
rusty_mode = "auto"

# Docker镜像（Docker模式）
rusty_docker_image = "rusty-st-compiler:latest"
```

---

## 🎮 动画控制

### 控制按钮

| 按钮 | 功能 |
|------|------|
| ▶ Play | 播放动画 |
| ⏸ Pause | 暂停 |
| ⏭ Step | 单步执行 |
| ↺ Reset | 重置到开始 |

### 键盘快捷键

| 快捷键 | 功能 |
|--------|------|
| `空格` | 播放/暂停 |
| `→` | 下一步 |
| `←` | 上一步 |
| `R` | 重置 |

---

## ⚠️ 常见问题

### Q1: 代码生成失败

**检查项**:
1. API密钥是否正确配置
2. 网络是否可以访问API
3. API账户是否有余额

### Q2: 编译验证失败

**解决方案**:
1. 如果使用Docker模式，确保Docker正在运行
2. 尝试修改 `rusty_mode = "auto"`
3. 检查生成的代码是否符合ST语法

### Q3: 动画不显示

**检查项**:
1. 确保代码已成功生成
2. 确保编译验证通过
3. 尝试刷新浏览器（Ctrl+Shift+R）

---

## 📊 技术架构

```
用户输入（自然语言）
        ↓
┌───────────────────┐
│   CodeGenerator   │ ← LLM + RAG
└───────────────────┘
        ↓
┌───────────────────┐
│   ST代码生成      │ ← IEC-61131-3标准
└───────────────────┘
        ↓
┌───────────────────┐
│   Verifier        │ ← Rusty/MATIEC编译器
└───────────────────┘
        ↓
┌───────────────────┐
│   AutoFixer       │ ← LLM自动修复（可选）
└───────────────────┘
        ↓
┌───────────────────┐
│   STAnimator      │ ← 解析+模拟+HTML生成
└───────────────────┘
        ↓
可交互HTML动画
```

---

## 🎯 示例详细说明

### ⚡ 电机控制（入门级）

最简单的PLC控制示例，适合入门演示：
- 两个输入按钮：启动和停止
- 一个输出：电机状态
- 停止按钮优先级更高

### 🌡️ 温度控制（基础级）

经典的温度调节系统：
- 输入温度传感器读数
- 自动控制加热器和冷却器
- 带报警功能

### 🚦 交通灯控制（中级）

智能交通信号灯系统：
- 车辆检测和行人按钮输入
- 三色灯输出
- 紧急车辆优先逻辑

### 💧 水箱液位控制（中高级）

工业级液位控制系统：
- 多个输入：液位、流量
- 多个输出：进水阀、出水阀、水泵
- 高低液位报警
- 紧急情况处理

### 🛗 电梯控制系统（高级 - 状态机）

**最复杂的示例**，展示完整的状态机实现：

```
状态转换图:
                    ┌─────────┐
                    │  IDLE   │ ←─────────────────┐
                    └────┬────┘                   │
                         │ 有请求                  │
              ┌──────────┴──────────┐             │
              ↓                     ↓             │
        ┌──────────┐          ┌──────────┐        │
        │MOVING_UP │          │MOVING_DOWN│       │
        └────┬─────┘          └─────┬────┘        │
              │ 到达楼层             │             │
              └──────────┬──────────┘             │
                         ↓                        │
                  ┌────────────┐                  │
                  │DOOR_OPENING│                  │
                  └─────┬──────┘                  │
                        ↓                         │
                  ┌────────────┐                  │
                  │ DOOR_OPEN  │                  │
                  └─────┬──────┘                  │
                        ↓                         │
                  ┌────────────┐                  │
                  │DOOR_CLOSING│──────────────────┘
                  └────────────┘
```

**功能特点**：
- 6个状态的完整状态机
- 多输入多输出
- 安全逻辑（紧急停止、超重保护、门障碍物检测）
- 楼层显示和状态码输出

---

## 📝 自定义需求示例

除了使用预设示例，你也可以输入自定义需求：

### 示例: 传送带控制

```
创建一个传送带控制系统。

输入变量:
- start: BOOL (启动按钮)
- stop: BOOL (停止按钮)
- sensor1: BOOL (入口传感器)
- sensor2: BOOL (出口传感器)

输出变量:
- belt_motor: BOOL (传送带电机)
- counter: INT (物品计数)

逻辑:
- start按下启动传送带
- stop按下停止传送带
- 检测到物品通过sensor2时计数+1
```

---

## 📄 许可证

本项目仅供学习和演示使用。

---

## 🎉 开始演示！

```bash
./start.sh
# 然后打开 http://127.0.0.1:7860
```

**祝演示顺利！** 🚀

